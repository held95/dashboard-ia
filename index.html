<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Log TXT - IA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
.container { max-width: 1200px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
h1 { text-align:center; margin-bottom:20px; }
input[type=file] { display:block; margin-bottom:20px; }
table { border-collapse: collapse; width:100%; margin-bottom:30px; }
table th, table td { border:1px solid #ccc; padding:8px; text-align:center; }
table th { background:#0070f3; color:#fff; }
#resultado { padding:15px; background:#e6f7ff; border-left:5px solid #0070f3; border-radius:5px; white-space: pre-wrap; }
.loading { font-weight:bold; color:#0070f3; }
</style>
</head>
<body>
<div class="container">
<h1>Dashboard Log TXT - IA</h1>
<input type="file" id="fileInput" accept=".txt">
<div id="tableContainer"></div>

<canvas id="treemapChart" style="height:300px;"></canvas>
<canvas id="barChart" style="height:300px;"></canvas>
<canvas id="lineChart" style="height:300px;"></canvas>

<h2>Insights da IA</h2>
<div id="resultado"></div>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const tableContainer = document.getElementById("tableContainer");
const resultadoDiv = document.getElementById("resultado");

let parsedData = [];

fileInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        parseTXT(text);
        renderTable();
        generateCharts();
        generateInsights(text);
    };
    reader.readAsText(file, "UTF-8");
});

function parseTXT(txt) {
    const lines = txt.split("\n");
    parsedData = lines.map(line => {
        // Formato básico: "Data, Hora" + Mensagem
        const regex = /^(\d{2}\/\d{2}\/\d{4}), (\d{2}:\d{2}:\d{2})\s*(.*)$/;
        const match = line.match(regex);
        let data = "", hora = "", mensagem = "";
        if(match){
            data = match[1];
            hora = match[2];
            mensagem = match[3];
        }
        // Usuário (ex.: primeira palavra ou nome detectado)
        let usuario = "Desconhecido";
        if(mensagem.includes("Giovani de Oliveira Souza")) usuario = "Giovani de Oliveira Souza";
        else if(mensagem.includes("Giuliano Campolim Gagliotti")) usuario = "Giuliano Campolim Gagliotti";

        // Extrair Quantidade de Pacientes e Data do Registro
        let quantidade = null, dataRegistro = null;
        const qtdMatch = mensagem.match(/atendeu a (\d+) pacientes?/i);
        if(qtdMatch) quantidade = parseInt(qtdMatch[1]);
        const dataRegMatch = mensagem.match(/no dia (\d{2}\/\d{2}\/\d{2,4})/i);
        if(dataRegMatch) dataRegistro = dataRegMatch[1];

        return {
            Data: data,
            Hora: hora,
            Mensagem: mensagem,
            Usuario: usuario,
            TipoMensagem: "",
            AssuntoContexto: "",
            QuantidadePacientes: quantidade,
            DataRegistro: dataRegistro,
            TipoProcedimento: "",
            StatusAcao: "",
            Confirmacao: ""
        };
    });
}

// Renderiza tabela
function renderTable() {
    let html = "<table><tr>";
    const headers = ["Data","Hora","Mensagem","Usuario","TipoMensagem","AssuntoContexto","QuantidadePacientes","DataRegistro","TipoProcedimento","StatusAcao","Confirmacao"];
    headers.forEach(h => html += `<th>${h}</th>`);
    html += "</tr>";
    parsedData.forEach(row => {
        html += "<tr>";
        headers.forEach(h => html += `<td>${row[h] !== null ? row[h] : ""}</td>`);
        html += "</tr>";
    });
    html += "</table>";
    tableContainer.innerHTML = html;
}

// Gráficos
function generateCharts() {
    const dataByDateUser = {};
    parsedData.forEach(d => {
        if(d.DataRegistro && d.QuantidadePacientes !== null){
            const key = `${d.DataRegistro} | ${d.Usuario}`;
            dataByDateUser[key] = (dataByDateUser[key] || 0) + d.QuantidadePacientes;
        }
    });
    const labels = Object.keys(dataByDateUser);
    const values = Object.values(dataByDateUser);

    // Treemap (simulado via bar)
    new Chart(document.getElementById("treemapChart").getContext("2d"), {
        type:"bar",
        data:{ labels, datasets:[{label:"Pacientes por Data e Usuário", data:values, backgroundColor:"#0070f3"}] },
        options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });

    // Bar Chart
    new Chart(document.getElementById("barChart").getContext("2d"), {
        type:"bar",
        data:{ labels, datasets:[{label:"Pacientes", data:values, backgroundColor:"#ff7f0e"}] },
        options:{ responsive:true }
    });

    // Line Chart (Linear Regression simplificado)
    new Chart(document.getElementById("lineChart").getContext("2d"), {
        type:"line",
        data:{ labels, datasets:[{label:"Pacientes", data:values, borderColor:"#2ca02c", fill:false}] },
        options:{ responsive:true }
    });
}

// Envia todo o conteúdo do TXT para a IA Mistral
async function generateInsights(txt) {
    resultadoDiv.textContent = "Gerando insights...";
    try {
        const res = await fetch("/api/gerar-insight", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ dados: txt })
        });
        const json = await res.json();
        if(res.ok){
            resultadoDiv.textContent = json.insights;
        } else {
            resultadoDiv.textContent = `Erro: ${json.error || "Erro desconhecido"}`;
        }
    } catch(err){
        resultadoDiv.textContent = `Erro ao conectar com a IA: ${err.message}`;
    }
}
</script>
</body>
</html>
