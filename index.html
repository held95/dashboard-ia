<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard IA com CSV</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; padding: 30px; }
  .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
  h1 { text-align: center; margin-bottom: 25px; }
  input[type=file] { margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
  table th, table td { border: 1px solid #ddd; padding: 8px; font-size: 14px; text-align: center; }
  table th { background: #0070f3; color: #fff; }
  canvas { margin-bottom: 25px; }
  #resultado { padding: 15px; border-left: 5px solid #0070f3; background: #f1f5f9; white-space: pre-wrap; border-radius: 8px; }
  .loading { color: #0070f3; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <h1>Dashboard de Análise de CSV e Insights IA</h1>
  <input type="file" id="csvFile" accept=".csv" />
  <div id="tabela"></div>

  <canvas id="graficoBarras" height="150"></canvas>
  <canvas id="graficoLinear" height="150"></canvas>
  <canvas id="graficoTreemap" height="150"></canvas>
  
  <button id="gerarInsight">Gerar Insight de IA</button>
  <div id="resultado"></div>
</div>

<script>
let dadosCSV = [];

// Função para processar CSV
document.getElementById('csvFile').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      dadosCSV = results.data;
      mostrarTabela(dadosCSV);
      gerarGraficos(dadosCSV);
    }
  });
});

// Mostrar tabela na tela
function mostrarTabela(dados) {
  const tabelaDiv = document.getElementById('tabela');
  if (dados.length === 0) {
    tabelaDiv.innerHTML = "Nenhum dado encontrado no CSV.";
    return;
  }

  let html = '<table><thead><tr>';
  Object.keys(dados[0]).forEach(key => html += `<th>${key}</th>`);
  html += '</tr></thead><tbody>';
  
  dados.forEach(row => {
    html += '<tr>';
    Object.values(row).forEach(val => html += `<td>${val}</td>`);
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  tabelaDiv.innerHTML = html;
}

// Gerar gráficos (exemplo básico)
function gerarGraficos(dados) {
  // Exemplo: gráfico de barras da quantidade de pacientes por data
  const datas = [];
  const qtdPacientes = [];

  dados.forEach(row => {
    if (row['Data do Registro'] && row['Quantidade de Pacientes']) {
      datas.push(row['Data do Registro']);
      qtdPacientes.push(Number(row['Quantidade de Pacientes']) || 0);
    }
  });

  // Gráfico de barras
  new Chart(document.getElementById('graficoBarras'), {
    type: 'bar',
    data: { labels: datas, datasets: [{ label: 'Pacientes', data: qtdPacientes, backgroundColor: '#0070f3' }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  // Gráfico de regressão linear (exemplo simplificado)
  const linearChart = new Chart(document.getElementById('graficoLinear'), {
    type: 'line',
    data: { labels: datas, datasets: [{ label: 'Pacientes', data: qtdPacientes, borderColor: '#ff6f61', fill: false }] },
    options: { responsive: true, plugins: { legend: { display: true } } }
  });

  // Treemap (simulação com chart.js como pie chart)
  const treemapChart = new Chart(document.getElementById('graficoTreemap'), {
    type: 'pie',
    data: { labels: datas, datasets: [{ data: qtdPacientes, backgroundColor: datas.map((_,i) => `hsl(${i*20},70%,50%)`) }] },
    options: { responsive: true }
  });
}

// Gerar Insight com IA Mistral
document.getElementById('gerarInsight').addEventListener('click', async () => {
  if (dadosCSV.length === 0) {
    document.getElementById('resultado').textContent = "Carregue um CSV antes de gerar insights.";
    return;
  }

  const textoDados = dadosCSV.map(d => `Data: ${d['Data do Registro']}, Pacientes: ${d['Quantidade de Pacientes']}`).join("\n");
  const resultadoDiv = document.getElementById('resultado');
  resultadoDiv.innerHTML = "<span class='loading'>Gerando insight...</span>";

  try {
    const resposta = await fetch("/api/gerar-insight", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ dados: textoDados })
    });
    const json = await resposta.json();
    if (resposta.ok) {
      resultadoDiv.textContent = json.insights;
    } else {
      resultadoDiv.textContent = `Erro: ${json.error || "Erro desconhecido"}`;
    }
  } catch(err) {
    resultadoDiv.textContent = `Erro ao conectar com a API: ${err.message}`;
  }
});
</script>

</body>
</html>
