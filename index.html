<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Dashboard com IA (Mistral)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<h2>Comparação entre Usuários</h2>

<label>Selecione usuários:</label>
<select id="usuariosSelect" multiple>
  <option value="Usuário A">Usuário A</option>
  <option value="Usuário B">Usuário B</option>
  <option value="Usuário C">Usuário C</option>
  <option value="Usuário D">Usuário D</option>
</select>

<button onclick="atualizarGraficos()">Atualizar Gráficos</button>
<button onclick="gerarInsightsIA()">Gerar Insights com IA</button>

<h3>Gráfico de Barras</h3>
<canvas id="graficoBarras"></canvas>

<h3>Linear Regression</h3>
<div id="graficoLinear"></div>

<h3>Treemap</h3>
<div id="graficoTreemap"></div>

<h3>Random Forest (importância de variáveis)</h3>
<div id="graficoRF"></div>

<h3>Insights da IA</h3>
<div id="insightsIA" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px;"></div>

<script>
const dataset = {
  "Usuário A": [10, 15, 20, 25],
  "Usuário B": [12, 18, 22, 30],
  "Usuário C": [8, 12, 15, 19],
  "Usuário D": [14, 20, 25, 28]
};

let chartBarras;

function atualizarGraficos() {
  const usuariosSelecionados = Array.from(document.getElementById("usuariosSelect").selectedOptions).map(o => o.value);
  if (!usuariosSelecionados.length) {
    alert("Selecione pelo menos um usuário!");
    return;
  }

  // Gráfico de Barras
  const ctx = document.getElementById("graficoBarras").getContext("2d");
  if (chartBarras) chartBarras.destroy();
  chartBarras = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Período 1","Período 2","Período 3","Período 4"],
      datasets: usuariosSelecionados.map((u,i) => ({
        label: u,
        data: dataset[u],
        backgroundColor: ["#ff6384","#36a2eb","#4bc0c0","#9966ff"][i % 4]
      }))
    }
  });

  // Linear Regression
  const traces = usuariosSelecionados.map((u,i) => ({
    x: [1,2,3,4],
    y: dataset[u],
    mode: "lines+markers",
    name: u,
    line: { color: ["red","blue","green","purple"][i % 4] }
  }));
  Plotly.newPlot("graficoLinear", traces);

  // Treemap
  const treemap = [{
    type: "treemap",
    labels: usuariosSelecionados,
    parents: usuariosSelecionados.map(() => ""),
    values: usuariosSelecionados.map(u => dataset[u].reduce((a,b)=>a+b,0)),
    textinfo: "label+percent entry",
    marker: { colors: ["#ff9999","#99ccff","#99ff99","#ffcc99"] }
  }];
  Plotly.newPlot("graficoTreemap", treemap);

  // Random Forest (exemplo fake)
  const rf = usuariosSelecionados.map((u,i) => ({
    x: ["Var1","Var2","Var3"],
    y: [Math.random()*10, Math.random()*10, Math.random()*10],
    type: "bar",
    name: u
  }));
  Plotly.newPlot("graficoRF", rf);
}

async function gerarInsightsIA() {
  const usuariosSelecionados = Array.from(document.getElementById("usuariosSelect").selectedOptions).map(o => o.value);
  const resumo = usuariosSelecionados.map(u => {
    const soma = dataset[u].reduce((a,b)=>a+b,0);
    const media = soma / dataset[u].length;
    return `${u} -> Soma: ${soma}, Média: ${media.toFixed(2)}, Valores: [${dataset[u].join(", ")}]`;
  }).join(" | ");

  document.getElementById("insightsIA").innerText = "⏳ Gerando insights...";

  const response = await fetch("/api/mistral", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ dados: resumo })
  });

  const data = await response.json();
  document.getElementById("insightsIA").innerText = data.insights || "Erro ao gerar insights.";
}
</script>
</body>
</html>
