<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Logs - IA</title>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 30px;
  background-color: #f9f9f9;
}
h1 { color: #333; text-align:center; margin-bottom:20px;}
input[type="file"] {
  margin-bottom: 20px;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  background-color: #0070f3;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
button:hover { background-color: #0055c7; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
th {
  background-color: #0070f3;
  color: #fff;
}
#resultado { margin-top:20px; padding:10px; background:#fff; border-radius:5px; }
</style>
</head>
<body>

<h1>Dashboard Logs - IA</h1>

<input type="file" id="fileInput" accept=".txt">
<button id="processar">Processar Log</button>

<div id="preview"></div>
<div id="resultado"></div>

<script>
const fileInput = document.getElementById("fileInput");
const processarBtn = document.getElementById("processar");
const previewDiv = document.getElementById("preview");
const resultadoDiv = document.getElementById("resultado");

let jsonData = [];

function parseLogToJSON(logText) {
  const lines = logText.split(/\r?\n/).filter(l=>l.trim()!=="");
  const dataArray = [];

  for (let i = 0; i < lines.length; i+=2) {
    const linhaData = lines[i];
    const mensagem = lines[i+1] || "";

    const [dataRaw, horaRaw] = linhaData.split(", ");
    let data = dataRaw || "";
    let hora = horaRaw || "";

    // Extrair quantidade de pacientes
    let qtdPacientesMatch = mensagem.match(/atendeu a (\d+)/);
    let qtdPacientes = qtdPacientesMatch ? parseInt(qtdPacientesMatch[1]) : "";

    // Extrair data do registro
    let dataRegistroMatch = mensagem.match(/no dia (\d{2}\/\d{2}\/\d{2,4})/);
    let dataRegistro = dataRegistroMatch ? dataRegistroMatch[1] : "";

    // Tipo de procedimento
    let tipoProcedimento = "";
    if(mensagem.toLowerCase().includes("cirurgia")) tipoProcedimento = "Cirurgias";
    else if(mensagem.toLowerCase().includes("visitas")) tipoProcedimento = "Visitas";
    else if(mensagem.toLowerCase().includes("ambulatorial")) tipoProcedimento = "Ambulatório";

    // Status ação
    let status = mensagem.toLowerCase().includes("registro concluído") ? "Concluído" : "";

    // Confirmação
    let confirmacao = (mensagem.trim()==="Sim" || mensagem.trim()==="Não") ? mensagem.trim() : "";

    dataArray.push({
      Data: data,
      Hora: hora,
      Mensagem: mensagem,
      Usuario: "Sistema",
      TipoMensagem: "",
      Assunto: "",
      QuantidadePacientes: qtdPacientes,
      DataRegistro: dataRegistro,
      TipoProcedimento: tipoProcedimento,
      StatusAcao: status,
      Confirmacao: confirmacao
    });
  }

  return dataArray;
}

processarBtn.addEventListener("click", () => {
  const file = fileInput.files[0];
  if (!file) {
    alert("Selecione um arquivo TXT");
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    jsonData = parseLogToJSON(text);

    // Mostrar tabela preview (5 linhas)
    let html = "<table><tr><th>Data</th><th>Hora</th><th>Mensagem</th><th>Qtd Pacientes</th><th>Data Registro</th></tr>";
    jsonData.slice(0,5).forEach(row=>{
      html += `<tr>
        <td>${row.Data}</td>
        <td>${row.Hora}</td>
        <td>${row.Mensagem}</td>
        <td>${row.QuantidadePacientes}</td>
        <td>${row.DataRegistro}</td>
      </tr>`;
    });
    html += "</table>";
    previewDiv.innerHTML = html;

    // Aqui você pode chamar suas funções de gráfico usando jsonData
    resultadoDiv.textContent = "JSON processado. Pronto para gerar gráficos e enviar à IA.";
  };
  reader.readAsText(file);
});

// Exemplo de como enviar para a Mistral
async function enviarParaIA(jsonData) {
  try {
    const resposta = await fetch("/api/gerar-insight", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ dados: JSON.stringify(jsonData) })
    });
    const json = await resposta.json();
    console.log(json);
    resultadoDiv.textContent = json.insights;
  } catch(err) {
    resultadoDiv.textContent = "Erro ao enviar para IA: " + err.message;
  }
}
</script>

</body>
</html>
