<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Insights</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; color: #333; }
  input, button { padding: 8px; margin: 5px 0; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #333; color: white; }
  #insightsLocal, #insightsIA { margin-top: 20px; padding: 10px; background: #fff; border-radius: 5px; }
  .btn { cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 3px; }
  .btn:hover { background-color: #0056b3; }
  #charts { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
  canvas { background: #fff; border-radius: 5px; padding: 10px; }
</style>
</head>
<body>

<h1>Dashboard de Insights</h1>

<input type="file" id="fileInput" accept=".csv" />
<button class="btn" id="btnProcess">Processar Insights Locais</button>
<button class="btn" id="btnIA">Gerar Insight com IA</button>

<div id="insightsLocal">
  <h2>Insights Locais</h2>
  <div id="localData"></div>
</div>

<div id="insightsIA">
  <h2>Insights da IA</h2>
  <div id="iaData">Nenhum insight gerado ainda.</div>
</div>

<div id="charts">
  <canvas id="chart1" width="400" height="200"></canvas>
  <canvas id="chart2" width="400" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let csvData = [];

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines.shift().split(',');
  return lines.map(line => {
    const data = line.split(',');
    return headers.reduce((obj, header, i) => { obj[header] = data[i]; return obj; }, {});
  });
}

function generateLocalInsights(data) {
  if (!data.length) return "Nenhum dado carregado.";
  const totalRows = data.length;
  const sampleColumn = Object.keys(data[0])[0];
  const uniqueValues = [...new Set(data.map(d => d[sampleColumn]))];
  return `
    <p>Total de registros: ${totalRows}</p>
    <p>Valores Ãºnicos da primeira coluna (${sampleColumn}): ${uniqueValues.join(', ')}</p>
  `;
}

function renderCharts(data) {
  const ctx1 = document.getElementById('chart1').getContext('2d');
  const ctx2 = document.getElementById('chart2').getContext('2d');

  const column = Object.keys(data[0])[0];
  const counts = {};
  data.forEach(row => counts[row[column]] = (counts[row[column]] || 0) + 1);

  const chart1 = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{ label: column, data: Object.values(counts), backgroundColor: 'rgba(0,123,255,0.7)' }]
    }
  });

  const chart2 = new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{ label: column, data: Object.values(counts), backgroundColor: Object.keys(counts).map(()=>'rgba('+Math.floor(Math.random()*255)+','+Math.floor(Math.random()*255)+','+Math.floor(Math.random()*255)+',0.7)') }]
    }
  });
}

document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => { csvData = parseCSV(evt.target.result); };
  reader.readAsText(file);
});

document.getElementById('btnProcess').addEventListener('click', () => {
  document.getElementById('localData').innerHTML = generateLocalInsights(csvData);
  if(csvData.length) renderCharts(csvData);
});

document.getElementById('btnIA').addEventListener('click', async () => {
  const iaDiv = document.getElementById('iaData');
  iaDiv.innerHTML = "Gerando insights com IA...";
  try {
    // Substitua abaixo pela sua chamada real para Mistral
    const response = await fetch('/api/mistral', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: csvData })
    });
    const result = await response.json();
    iaDiv.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
  } catch(err) {
    iaDiv.innerHTML = "Erro ao gerar insights com IA.";
    console.error(err);
  }
});
</script>

</body>
</html>
